<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KryptoPesa | Dashboard</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f0f4f8;color:#1a1a2e;min-height:100vh;}
    header{background:#1a237e;color:#fff;padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:68px;position:sticky;top:0;z-index:200;box-shadow:0 2px 10px rgba(0,0,0,.3);}
    .logo{display:flex;align-items:center;gap:10px;}
    .logo img{height:36px;width:auto;border-radius:6px;}
    .header-right{display:flex;align-items:center;gap:12px;}
    .kyc-badge{padding:5px 13px;border-radius:20px;font-size:11px;font-weight:800;cursor:pointer;letter-spacing:.4px;transition:all .2s;}
    .kyc-badge.unverified{background:rgba(220,38,38,.2);color:#fca5a5;border:1px solid rgba(220,38,38,.4);}
    .kyc-badge.pending{background:rgba(217,119,6,.2);color:#fcd34d;border:1px solid rgba(217,119,6,.4);}
    .kyc-badge.verified{background:rgba(5,150,105,.2);color:#6ee7b7;border:1px solid rgba(5,150,105,.4);}
    .user-name{font-size:13px;color:rgba(255,255,255,.8);font-weight:600;}
    .user-menu-wrap{position:relative;}
    .menu-btn{background:transparent;border:none;color:#fff;font-size:1.6rem;cursor:pointer;padding:8px;border-radius:6px;line-height:1;transition:background .2s;}
    .menu-btn:hover{background:rgba(255,255,255,.12);}
    .dropdown{position:absolute;top:calc(100% + 8px);right:0;background:#fff;border:1px solid #e2e8f0;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.15);min-width:190px;display:none;z-index:500;}
    .dropdown.open{display:block;}
    .dd-item{display:flex;align-items:center;gap:10px;width:100%;padding:11px 16px;background:none;border:none;font-size:14px;color:#1e293b;font-weight:500;cursor:pointer;text-align:left;font-family:inherit;transition:background .15s;}
    .dd-item:hover{background:#f8fafc;color:#1a237e;}
    .dd-item.red:hover{color:#dc2626;}
    .dd-sep{border:none;border-top:1px solid #e2e8f0;margin:4px 0;}
    .main-nav{background:#fff;border-bottom:1px solid #e2e8f0;overflow-x:auto;}
    .nav-inner{display:flex;padding:0 16px;}
    .nav-btn{padding:14px 20px;border:none;background:transparent;color:#64748b;font-weight:600;font-size:14px;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;font-family:inherit;transition:all .2s;display:flex;align-items:center;gap:7px;}
    .nav-btn:hover{color:#1a237e;background:#f8fafc;}
    .nav-btn.active{color:#1a237e;border-bottom-color:#1a237e;}
    .main{max-width:1200px;margin:0 auto;padding:28px 20px 90px;}
    .section{display:none;}
    .section.active{display:block;}
    .sec-hdr{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:14px;margin-bottom:24px;}
    .sec-hdr h2{font-size:1.5rem;font-weight:800;color:#0f172a;}
    .sec-hdr p{font-size:.85rem;color:#64748b;margin-top:3px;}
    .ws-badge{display:inline-flex;align-items:center;gap:7px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;}
    .ws-badge.live{background:rgba(5,150,105,.1);border:1px solid #059669;color:#059669;}
    .ws-badge.cached{background:rgba(220,38,38,.1);border:1px solid #dc2626;color:#dc2626;}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;}
    .dot.live{background:#059669;}
    .dot.cached{background:#dc2626;}
    .rate-box{background:#fff;border:1px solid #e2e8f0;border-radius:9px;padding:8px 14px;font-size:13px;color:#64748b;}
    .rate-box span{color:#059669;font-weight:800;}
    .price-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:18px;}
    .price-card{background:#fff;border:1.5px solid #e2e8f0;border-radius:14px;padding:22px;box-shadow:0 1px 4px rgba(0,0,0,.06);transition:all .2s;}
    .price-card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.1);}
    .ci{display:flex;align-items:center;gap:11px;margin-bottom:14px;}
    .cicon{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;color:#fff;}
    .cname{font-weight:700;font-size:15px;color:#0f172a;}
    .csym{font-size:12px;color:#64748b;}
    .cprice{font-size:1.2rem;font-weight:800;color:#0f172a;}
    .ckes{font-size:12px;color:#64748b;margin-top:2px;}
    .cchg{font-size:13px;font-weight:700;margin-top:5px;}
    .pos{color:#059669;} .neg{color:#dc2626;}
    .card{background:#fff;border:1.5px solid #e2e8f0;border-radius:14px;padding:28px;max-width:500px;box-shadow:0 1px 4px rgba(0,0,0,.06);}
    .card h2{font-size:1.3rem;font-weight:800;margin-bottom:4px;}
    .card-sub{font-size:.85rem;color:#64748b;margin-bottom:22px;}
    .fg{margin-bottom:18px;}
    .fl{display:block;margin-bottom:7px;font-weight:700;font-size:12px;color:#374151;text-transform:uppercase;letter-spacing:.5px;}
    .fi,.fs{width:100%;padding:12px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:15px;font-family:inherit;background:#fff;transition:border-color .2s;}
    .fi:focus,.fs:focus{outline:none;border-color:#1a237e;box-shadow:0 0 0 3px rgba(26,35,126,.1);}
    .notice{display:flex;gap:8px;background:#fefce8;border:1px solid #fde047;border-radius:8px;padding:10px 14px;font-size:13px;color:#713f12;margin-bottom:18px;line-height:1.5;}
    .conv-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px 14px;margin-bottom:18px;font-size:13px;color:#1e40af;}
    .conv-big{font-size:1.1rem;font-weight:800;color:#1e3a8a;}
    .climit{font-size:11px;margin-top:4px;font-weight:600;}
    .climit.ok{color:#059669;} .climit.bad{color:#dc2626;}
    .prim-btn{width:100%;padding:14px;background:#1a237e;color:#fff;border:none;border-radius:9px;font-weight:800;font-size:15px;cursor:pointer;transition:all .2s;font-family:inherit;}
    .prim-btn:hover{background:#0d47a1;transform:translateY(-1px);}
    .prim-btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    .result{margin-top:14px;padding:12px 14px;border-radius:9px;font-size:14px;font-weight:600;line-height:1.7;}
    .result.ok{background:rgba(5,150,105,.1);color:#059669;border:1px solid rgba(5,150,105,.25);}
    .result.err{background:rgba(220,38,38,.1);color:#dc2626;border:1px solid rgba(220,38,38,.25);}
    .result.warn{background:rgba(217,119,6,.1);color:#d97706;border:1px solid rgba(217,119,6,.25);}
    .kyc-gate{text-align:center;padding:52px 24px;border:2px dashed #cbd5e1;border-radius:14px;max-width:460px;background:#fff;}
    .kyc-gate .gi{font-size:52px;margin-bottom:14px;}
    .kyc-gate h3{font-size:1.3rem;font-weight:800;margin-bottom:10px;}
    .kyc-gate p{font-size:.9rem;color:#64748b;line-height:1.7;margin-bottom:24px;}
    .kyc-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 28px;background:#ffd600;color:#1a237e;border:none;border-radius:9px;font-weight:800;font-size:14px;cursor:pointer;text-decoration:none;transition:all .2s;}
    .kyc-btn:hover{background:#e6c200;transform:translateY(-1px);}
    .kyc-note{font-size:11px;color:#94a3b8;margin-top:12px;}
    .addr-grid{display:grid;gap:16px;}
    .addr-card{background:#fff;border:1.5px solid #e2e8f0;border-radius:12px;padding:20px;transition:border-color .2s;}
    .addr-card:hover{border-color:#1a237e;}
    .addr-head{display:flex;align-items:center;gap:11px;margin-bottom:12px;}
    .addr-title{font-size:15px;font-weight:700;}
    .net-pill{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe;}
    .addr-lbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:#64748b;display:block;margin-bottom:5px;}
    .addr-box{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 12px;font-size:11.5px;word-break:break-all;display:flex;align-items:flex-start;justify-content:space-between;gap:10px;}
    .copy-btn{flex-shrink:0;padding:4px 9px;background:#fff;border:1px solid #e2e8f0;border-radius:6px;cursor:pointer;font-size:13px;transition:all .2s;}
    .copy-btn:hover{background:#1a237e;color:#fff;border-color:#1a237e;}
    .addr-warn{font-size:11.5px;color:#d97706;margin-top:7px;font-weight:600;}
    .coming{text-align:center;padding:56px 24px;color:#64748b;}
    .coming .ci2{font-size:56px;opacity:.4;margin-bottom:14px;}
    .coming h3{font-size:1.2rem;font-weight:700;color:#0f172a;margin-bottom:6px;}
    footer{position:fixed;bottom:0;width:100%;background:#1a237e;color:#fff;text-align:center;padding:10px;font-size:13px;}
    footer a{color:#ffd600;text-decoration:none;}
    @media(max-width:600px){.price-grid{grid-template-columns:1fr 1fr;gap:12px;}.main{padding:16px 12px 90px;}.card{padding:20px;}}
    @media(max-width:380px){.price-grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<header>
  <div class="logo">
    <img src="logo.jpg" alt="KryptoPesa">
  </div>
  <div class="header-right">
    <span id="userName" class="user-name"></span>
    <span id="kycBadge" class="kyc-badge unverified" onclick="handleKYCClick()">üîí KYC Unverified</span>
    <div class="user-menu-wrap">
      <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
      <div id="dd" class="dropdown">
        <button class="dd-item" onclick="showSection('markets');closeMenu()"> Markets</button>
        <button class="dd-item" onclick="handleKYCClick()"> Verify KYC</button>
        <hr class="dd-sep">
       <button class="dd-item red" onclick="window.location.href='index.html'">Sign Out</button>
      </div>
    </div>
  </div>
</header>

<nav class="main-nav">
  <div class="nav-inner">
    <button class="nav-btn active" data-sec="markets" onclick="showSection('markets')"> Markets</button>
    <button class="nav-btn" data-sec="swap" onclick="showSection('swap')"> Swap to M-Pesa</button>
    <button class="nav-btn" data-sec="receive" onclick="showSection('receive')"> Receive Crypto</button>
    <button class="nav-btn" data-sec="deposit" onclick="showSection('deposit')">Deposit</button>
  </div>
</nav>

<main class="main">
  <!-- MARKETS -->
  <section id="markets" class="section active">
    <div class="sec-hdr">
      <div><h2>Live Market Prices</h2><p>Real-time prices ¬∑ Converted to Kenyan Shillings</p></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <div class="rate-box">USD/KES: <span id="kesDisplay">‚Äî</span></div>
        <div id="wsBadge" class="ws-badge cached"><span class="dot cached" id="wsDot"></span><span id="wsText">Connecting‚Ä¶</span></div>
      </div>
    </div>
    <div id="priceGrid" class="price-grid"></div>
  </section>

  <!-- SWAP -->
  <section id="swap" class="section">
    <div class="card">
      <h2> Swap to M-Pesa</h2>
      <p class="card-sub">Convert crypto to KSH ‚Äî sent directly to your M-Pesa</p>
      <div class="notice"> Transaction limits: <strong>&nbsp;KSH 100 minimum</strong> ¬∑ <strong>KSH 300,000 maximum</strong></div>
      <div class="fg">
        <label class="fl">Cryptocurrency</label>
        <select id="swapCrypto" class="fs" onchange="calcConv()">
          <option value="BTC">Bitcoin (BTC)</option>
          <option value="ETH">Ethereum (ETH)</option>
          <option value="SOL">Solana (SOL)</option>
          <option value="USDT">Tether (USDT)</option>
          <option value="WLD">Worldcoin (WLD)</option>
        </select>
      </div>
      <div class="fg">
        <label class="fl">Amount (crypto)</label>
        <input type="number" id="swapAmt" class="fi" placeholder="e.g. 0.001" min="0" step="any" oninput="calcConv()">
      </div>
      <div id="convBox" class="conv-box" style="display:none;">
        ‚âà KSH <span id="kesAmt" class="conv-big">0.00</span>
        <div class="climit" id="limitLbl"></div>
        <div style="font-size:11px;margin-top:3px;color:#3b82f6;">1 <span id="rateSym">BTC</span> = KSH <span id="rateVal">‚Äî</span></div>
      </div>
      <div class="fg">
        <label class="fl">M-Pesa Number</label>
        <input type="text" id="mpesaNum" class="fi" placeholder="07XXXXXXXX or 01XXXXXXXX" maxlength="10">
      </div>
      <button id="swapBtn" class="prim-btn" onclick="doSwap()"> Swap to M-Pesa</button>
      <div id="swapResult"></div>
    </div>
  </section>

  <!-- RECEIVE -->
  <section id="receive" class="section">
    <div id="kycGate" class="kyc-gate">
      <div class="gi"></div>
      <h3>KYC Verification Required</h3>
      <p>To receive cryptocurrency and view your wallet addresses, you must complete identity verification. This keeps your account safe and meets regulatory requirements.</p>
      <a href="https://usesmileid.com/products/smartselfie" target="_blank" class="kyc-btn" onclick="onKYCLink()"> Verify My Identity ‚Üí</a>
      <p class="kyc-note">Powered by SmileID ¬∑ Secure &amp; Encrypted ¬∑ ~2 minutes</p>
    </div>
    <div id="receiveContent" style="display:none;">
      <div class="sec-hdr">
        <div><h2> Receive Cryptocurrency</h2><p>Send crypto to your verified KryptoPesa wallet addresses. Always confirm the correct network before sending.</p></div>
      </div>
      <div id="addrGrid" class="addr-grid"></div>
    </div>
  </section>

  <!-- DEPOSIT -->
  <section id="deposit" class="section">
    <div class="card">
      <div class="coming">
        <div class="ci2"></div>
        <h3>M-Pesa Deposit Coming Soon</h3>
        <p>Direct M-Pesa to crypto deposits are being integrated. Stay tuned!</p>
      </div>
    </div>
  </section>
</main>

<footer>¬© 2025 KryptoPesa ‚Äî Secure Crypto Trading | <a href="mailto:support@kryptopesa.com">support@kryptopesa.com</a></footer>

<script>
const MIN_KES=100, MAX_KES=300000;

const CMETA={
  BTC:{name:'Bitcoin',   sym:'BTC',  icon:'‚Çø',  bg:'#f7931a',wk:'BTCUSDT'},
  ETH:{name:'Ethereum',  sym:'ETH',  icon:'Œû',  bg:'#627eea',wk:'ETHUSDT'},
  SOL:{name:'Solana',    sym:'SOL',  icon:'‚óé',  bg:'#9945ff',wk:'SOLUSDT'},
  USDT:{name:'Tether',   sym:'USDT', icon:'‚ÇÆ',  bg:'#26a17b',wk:'USDTUSDT'},
  WLD:{name:'Worldcoin', sym:'WLD',  icon:'üåê', bg:'#1a1a1a',wk:'WLDUSDT'}
};

const ADDRS={
  BTC:{net:'Bitcoin (BTC Native SegWit)',addr:'bc1qkp0rqpwr5l3d5l69kjrsvvq27c8gx3d48s7jy4',warn:'‚ö†Ô∏è Only send BTC on the Bitcoin network. Do NOT use BSC or other networks.'},
  ETH:{net:'Ethereum (ERC-20)',addr:'0x7A0fC9f49fE7F6bAfEe1a81e3A5b9C55c7bE3f21',warn:'‚ö†Ô∏è Send ETH on Ethereum mainnet (ERC-20) only.'},
  SOL:{net:'Solana (SOL)',addr:'8cSeXM9HPCgkWRCn5Pxx9uWNXwR7bFP7E9CkEf2NBXPB',warn:'‚ö†Ô∏è Send SOL on the Solana network only.'},
  USDT:{net:'Ethereum (ERC-20)',addr:'0x9a8f92a830A5cB89a3816e3D267CB7791c16b04D',warn:'‚ö†Ô∏è USDT on ERC-20 only here.',alt:{net:'TRON (TRC-20)',addr:'TMBHYu6bZqRaA1HZjYBzVBdCJNiLVP9RLM'}},
  WLD:{net:'Optimism (OP Mainnet)',addr:'0x4C5c2e9E6F1234567890Ab3456789012cDEf2345',warn:'‚ö†Ô∏è WLD is on Optimism. Do NOT send on Ethereum mainnet.'}
};

const prices={BTC:87000,ETH:3100,SOL:155,USDT:1,WLD:1.80};
const WS_SYMBOLS=['BTCUSDT','ETHUSDT','SOLUSDT','WLDUSDT'];
let kesRate=130, ws=null, reconnects=0;

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
function checkAuth(){
  if(!localStorage.getItem('isLoggedIn')||!localStorage.getItem('currentUser')){window.location.replace('login.html');return false;}
  const users=JSON.parse(localStorage.getItem('kryptopesa_users_db')||'[]');
  const u=users.find(x=>x.username===localStorage.getItem('currentUser'));
  if(u&&u.status==='suspended'){alert('Account suspended. Contact support@kryptopesa.com');doLogout(true);return false;}
  return true;
}
function doLogout(skip){
  if(!skip&&!confirm('Sign out of KryptoPesa?'))return;
  logAct('User Logout',localStorage.getItem('currentUser')||'?','success');
  localStorage.removeItem('isLoggedIn');localStorage.removeItem('currentUser');sessionStorage.clear();
  if(ws)ws.close();
  window.location.replace('login.html');
}
function esc(s){return String(s).replace(/[<>"'&]/g,c=>({'<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','&':'&amp;'}[c]));}

// ‚îÄ‚îÄ KYC ‚îÄ‚îÄ
function getKYC(){
  const user=localStorage.getItem('currentUser');
  const users=JSON.parse(localStorage.getItem('kryptopesa_users_db')||'[]');
  const rec=users.find(u=>u.username===user);
  if(rec&&rec.kycVerified)return'verified';
  if(localStorage.getItem('kyc_sub_'+user)==='submitted')return'pending';
  return'unverified';
}
function refreshKYCBadge(){
  const s=getKYC(),b=document.getElementById('kycBadge');
  if(s==='verified'){b.className='kyc-badge verified';b.textContent=' KYC Verified';}
  else if(s==='pending'){b.className='kyc-badge pending';b.textContent='KYC Pending';}
  else{b.className='kyc-badge unverified';b.textContent='KYC Unverified';}
}
function handleKYCClick(){
  closeMenu();
  if(getKYC()==='verified'){alert('KYC already verified ');return;}
  window.open('https://usesmileid.com/products/smartselfie','_blank');
  onKYCLink();
}
function onKYCLink(){
  const user=localStorage.getItem('currentUser');
  if(getKYC()!=='verified'){localStorage.setItem('kyc_sub_'+user,'submitted');logAct('KYC Submitted',user,'pending');refreshKYCBadge();}
}

// ‚îÄ‚îÄ RECEIVE ‚îÄ‚îÄ
function checkReceive(){
  if(getKYC()==='verified'){
    document.getElementById('kycGate').style.display='none';
    document.getElementById('receiveContent').style.display='block';
    buildAddrs();
  } else {
    document.getElementById('kycGate').style.display='block';
    document.getElementById('receiveContent').style.display='none';
  }
}
function buildAddrs(){
  const g=document.getElementById('addrGrid');
  if(g.children.length>0)return;
  g.innerHTML='';
  Object.entries(CMETA).forEach(([key,meta])=>{
    const info=ADDRS[key];
    const d=document.createElement('div');d.className='addr-card';
    d.innerHTML=`
      <div class="addr-head">
        <div class="cicon" style="width:38px;height:38px;background:${meta.bg};font-size:16px;">${meta.icon}</div>
        <div><div class="addr-title">${esc(meta.name)}</div><span class="net-pill">${esc(info.net)}</span></div>
      </div>
      <label class="addr-lbl">${esc(key)} Address</label>
      <div class="addr-box"><span id="a_${key}">${esc(info.addr)}</span><button class="copy-btn" onclick="cpAddr('a_${key}',this)">üìã</button></div>
      ${info.alt?`<label class="addr-lbl" style="margin-top:10px;">${esc(info.alt.net)}</label><div class="addr-box"><span id="a_${key}_alt">${esc(info.alt.addr)}</span><button class="copy-btn" onclick="cpAddr('a_${key}_alt',this)">üìã</button></div>`:''}
      <p class="addr-warn">${esc(info.warn)}</p>`;
    g.appendChild(d);
  });
}
function cpAddr(id,btn){
  const t=document.getElementById(id).textContent;
  navigator.clipboard.writeText(t).then(()=>{
    const o=btn.textContent;btn.textContent='';btn.style.background='#059669';btn.style.color='#fff';
    setTimeout(()=>{btn.textContent=o;btn.style.background='';btn.style.color='';},1800);
  }).catch(()=>{
    const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    btn.textContent='';setTimeout(()=>btn.textContent='',1500);
  });
}

// ‚îÄ‚îÄ KES RATE ‚îÄ‚îÄ
async function fetchKES(){
  for(const url of['https://api.exchangerate-api.com/v4/latest/USD','https://open.er-api.com/v6/latest/USD']){
    try{
      const r=await fetch(url);if(!r.ok)continue;
      const d=await r.json();const rate=d.rates?.KES||d.conversion_rates?.KES;
      if(rate){kesRate=rate;document.getElementById('kesDisplay').textContent=rate.toFixed(2);updateAllKES();return;}
    }catch(_){}
  }
  document.getElementById('kesDisplay').textContent=kesRate+' (est.)';
}
function updateAllKES(){
  Object.entries(CMETA).forEach(([k,m])=>{
    const el=document.getElementById('kes_'+m.wk);
    if(el)el.textContent='‚âà KES '+(prices[k]*kesRate).toLocaleString('en-KE',{maximumFractionDigits:0});
  });
  calcConv();
}

// ‚îÄ‚îÄ SWAP ‚îÄ‚îÄ
function calcConv(){
  const sym=document.getElementById('swapCrypto').value;
  const amt=parseFloat(document.getElementById('swapAmt').value);
  const box=document.getElementById('convBox');
  if(!amt||isNaN(amt)||amt<=0){box.style.display='none';return;}
  const usd=prices[sym]||1;const kes=amt*usd*kesRate;
  document.getElementById('kesAmt').textContent=kes.toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('rateSym').textContent=sym;
  document.getElementById('rateVal').textContent=(usd*kesRate).toLocaleString('en-KE',{maximumFractionDigits:2});
  const lbl=document.getElementById('limitLbl');
  if(kes<MIN_KES){lbl.textContent='‚ö†Ô∏è Below minimum (KSH '+MIN_KES.toLocaleString()+')';lbl.className='climit bad';}
  else if(kes>MAX_KES){lbl.textContent='‚ö†Ô∏è Exceeds maximum (KSH '+MAX_KES.toLocaleString()+')';lbl.className='climit bad';}
  else{lbl.textContent='‚úÖ Within allowed range';lbl.className='climit ok';}
  box.style.display='block';
}
function doSwap(){
  if(!checkAuth())return;
  const sym=document.getElementById('swapCrypto').value;
  const amt=parseFloat(document.getElementById('swapAmt').value);
  const num=document.getElementById('mpesaNum').value.trim();
  const res=document.getElementById('swapResult');
  const btn=document.getElementById('swapBtn');
  res.innerHTML='';
  if(!amt||isNaN(amt)||amt<=0){res.innerHTML='<div class="result err">‚ö†Ô∏è Enter a valid crypto amount.</div>';return;}
  if(!/^(07|01)\d{8}$/.test(num)){res.innerHTML='<div class="result err">‚ö†Ô∏è Enter a valid Kenyan M-Pesa number (07XX or 01XX, 10 digits).</div>';return;}
  const kes=amt*(prices[sym]||1)*kesRate;
  if(kes<MIN_KES){res.innerHTML='<div class="result err">‚ö†Ô∏è Minimum swap is KSH '+MIN_KES+'. Your amount = KSH '+kes.toFixed(2)+'.</div>';return;}
  if(kes>MAX_KES){res.innerHTML='<div class="result err">‚ö†Ô∏è Maximum swap is KSH '+MAX_KES.toLocaleString()+'. Your amount = KSH '+kes.toLocaleString('en-KE',{maximumFractionDigits:0})+'.</div>';return;}
  btn.disabled=true;
  res.innerHTML='<div class="result warn">‚è≥ Processing swap‚Ä¶</div>';
  setTimeout(()=>{
    const user=localStorage.getItem('currentUser');
    const txId='KP'+Date.now().toString(36).toUpperCase();
    const txs=JSON.parse(localStorage.getItem('kryptopesa_transactions_db')||'[]');
    txs.push({txId,username:user,type:'Swap',crypto:sym,amount:amt.toString(),kesAmount:kes.toFixed(2),mpesaNumber:num,status:'active',timestamp:new Date().toISOString()});
    if(txs.length>500)txs.splice(0,txs.length-500);
    localStorage.setItem('kryptopesa_transactions_db',JSON.stringify(txs));
    logAct('Swap Transaction',user,'success');
    res.innerHTML=`<div class="result ok"> Swap initiated!<br><strong>${amt} ${esc(sym)}</strong> ‚Üí <strong>KSH ${kes.toLocaleString('en-KE',{minimumFractionDigits:2,maximumFractionDigits:2})}</strong><br>Sending to: <strong>${esc(num)}</strong><br><small style="opacity:.8;">TX: ${txId}</small></div>`;
    document.getElementById('swapAmt').value='';document.getElementById('mpesaNum').value='';
    document.getElementById('convBox').style.display='none';btn.disabled=false;
  },2500);
}

// ‚îÄ‚îÄ PRICE CARDS ‚îÄ‚îÄ
function buildCards(){
  const g=document.getElementById('priceGrid');g.innerHTML='';
  Object.entries(CMETA).forEach(([key,m])=>{
    const p=prices[key]||0;
    const d=document.createElement('div');d.className='price-card';
    d.innerHTML=`<div class="ci"><div class="cicon" style="background:${m.bg};">${m.icon}</div><div><div class="cname">${m.name}</div><div class="csym">${m.sym}</div></div></div><div id="p_${m.wk}" class="cprice">$${p.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:p>1?2:6})}</div><div id="kes_${m.wk}" class="ckes">‚âà KES ${(p*kesRate).toLocaleString('en-KE',{maximumFractionDigits:0})}</div><div id="ch_${m.wk}" class="cchg pos">‚ñ≤ 0.00%</div>`;
    g.appendChild(d);
  });
}
function updCard(wk,price,chg){
  const pe=document.getElementById('p_'+wk),ke=document.getElementById('kes_'+wk),ce=document.getElementById('ch_'+wk);
  if(pe)pe.textContent='$'+price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:price>1?2:6});
  if(ke)ke.textContent='‚âà KES '+(price*kesRate).toLocaleString('en-KE',{maximumFractionDigits:0});
  if(ce){ce.textContent=(chg>=0?'‚ñ≤':'‚ñº')+' '+Math.abs(chg).toFixed(2)+'%';ce.className='cchg '+(chg>=0?'pos':'neg');}
  const e=Object.entries(CMETA).find(([,m])=>m.wk===wk);if(e)prices[e[0]]=price;
}
function setWS(live){
  const b=document.getElementById('wsBadge'),d=document.getElementById('wsDot'),t=document.getElementById('wsText');
  if(live){b.className='ws-badge live';d.className='dot live';t.textContent='Live';}
  else{b.className='ws-badge cached';d.className='dot cached';t.textContent='Cached';}
}
function connectWS(){
  if(ws&&(ws.readyState===WebSocket.OPEN||ws.readyState===WebSocket.CONNECTING))return;
  const streams=WS_SYMBOLS.map(s=>s.toLowerCase()+'@ticker').join('/');
  try{
    ws=new WebSocket('wss://stream.binance.com:9443/stream?streams='+streams);
    ws.onopen=()=>{reconnects=0;setWS(true);};
    ws.onmessage=(e)=>{
      try{const d=JSON.parse(e.data);const t=d.data||d;if(!t.s)return;const sym=t.s.toUpperCase();if(!WS_SYMBOLS.includes(sym))return;updCard(sym,parseFloat(t.c),parseFloat(t.P));calcConv();}catch(_){}
    };
    ws.onerror=()=>setWS(false);
    ws.onclose=()=>{setWS(false);if(reconnects<5){reconnects++;setTimeout(connectWS,Math.min(1000*Math.pow(2,reconnects),30000));}};
  }catch(_){setWS(false);}
}

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(b=>{if(b.getAttribute('data-sec')===id)b.classList.add('active');});
  if(id==='receive')checkReceive();
}
function toggleMenu(){document.getElementById('dd').classList.toggle('open');}
function closeMenu(){document.getElementById('dd').classList.remove('open');}
document.addEventListener('click',e=>{const dd=document.getElementById('dd');const mb=document.querySelector('.menu-btn');if(!dd?.contains(e.target)&&!mb?.contains(e.target))closeMenu();});

function logAct(ev,user,st){
  const log=JSON.parse(localStorage.getItem('kryptopesa_activity_log')||'[]');
  log.push({event:ev,user,status:st,timestamp:new Date().toISOString()});
  if(log.length>100)log.splice(0,50);
  localStorage.setItem('kryptopesa_activity_log',JSON.stringify(log));
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',async()=>{
  if(!checkAuth())return;
  const user=localStorage.getItem('currentUser');
  document.getElementById('userName').textContent=user;
  refreshKYCBadge();
  buildCards();
  connectWS();
  updCard('USDTUSDT',1.0,0.0);
  await fetchKES();
  updateAllKES();
  setInterval(async()=>{await fetchKES();updateAllKES();},300000);
  setTimeout(()=>{if(!ws||ws.readyState!==WebSocket.OPEN)setWS(false);},7000);
});
window.addEventListener('beforeunload',()=>{if(ws)ws.close();});
</script>
</body>
</html>
