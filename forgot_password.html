<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KryptoPesa — Forgot Password</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#1a237e 0%,#0d47a1 100%);min-height:100vh;display:flex;flex-direction:column;}
    .top-bar{padding:16px 24px;display:flex;align-items:center;gap:10px;}
    .logo-icon{width:38px;height:38px;background:#ffd600;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;color:#1a237e;}
    .brand{color:#fff;font-weight:700;font-size:1.2rem;}
    .center{flex:1;display:flex;align-items:center;justify-content:center;padding:20px;}
    .container{background:#fff;max-width:420px;width:100%;padding:36px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);}
    h2{text-align:center;color:#1a237e;margin-bottom:6px;font-size:1.6rem;font-weight:800;}
    .subtitle{text-align:center;color:#64748b;font-size:.875rem;margin-bottom:24px;}
    .form-group{margin-bottom:18px;}
    label{display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:#374151;text-transform:uppercase;letter-spacing:.4px;}
    input{width:100%;padding:12px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:15px;transition:border-color .2s;font-family:inherit;}
    input:focus{outline:none;border-color:#1a237e;box-shadow:0 0 0 3px rgba(26,35,126,.1);}
    .error-msg{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none;}
    .success-msg{background:#f0fdf4;border:1px solid #bbf7d0;color:#16a34a;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;display:none;}
    .btn{width:100%;padding:13px;background:#1a237e;color:#fff;border:none;border-radius:8px;font-weight:700;font-size:15px;cursor:pointer;transition:all .2s;font-family:inherit;}
    .btn:hover{background:#0d47a1;transform:translateY(-1px);}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    .link-row{text-align:center;margin-top:18px;font-size:.9rem;color:#64748b;}
    .link-row a{color:#1a237e;font-weight:700;text-decoration:none;}
    .link-row a:hover{text-decoration:underline;}
    footer{text-align:center;padding:16px;color:rgba(255,255,255,.7);font-size:.8rem;}
    .info-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:14px;margin-bottom:18px;font-size:13px;color:#1e40af;}
  </style>
</head>
<body>
  <div class="top-bar">
   
    <img src="logo.jpg" alt="KryptoPesa Logo" class="logo-icon">
    <span class="brand">KryptoPesa</span>
  </div>
  <div class="center">
    <div class="container">
      <h2>Reset Password</h2>
      <p class="subtitle">We'll generate a new secure password for you</p>
      <div class="error-msg" id="errorMsg"></div>
      <div class="success-msg" id="successMsg"></div>
      <div class="info-box">
        Enter your username below. A new secure password will be generated and you'll be redirected to create a new password.
      </div>
      <form id="forgotForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="forgotUsername" placeholder="Enter your username" required />
        </div>
        <button type="submit" class="btn" id="forgotBtn">Generate New Password</button>
      </form>
      <div class="link-row">
        Remember your password? <a href="login.html">Log In</a>
      </div>
      <div class="link-row">
        Don't have an account? <a href="signup.html">Sign Up</a>
      </div>
    </div>
  </div>
  <footer>© 2025 KryptoPesa. All rights reserved.</footer>

  <script>
    // Password Generator using crypto.getRandomValues() - JavaScript random selector
    // Generates mixed password with uppercase, lowercase, numbers, and symbols
    function generateSecurePassword(length = 12) {
      const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const lowercase = 'abcdefghijklmnopqrstuvwxyz';
      const numbers = '0123456789';
      const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
      
      const allChars = uppercase + lowercase + numbers + symbols;
      
      // Ensure at least one character from each category
      const randomUpper = uppercase[Math.floor(crypto.getRandomValues(new Uint8Array(1))[0] / 256 * uppercase.length)];
      const randomLower = lowercase[Math.floor(crypto.getRandomValues(new Uint8Array(1))[0] / 256 * lowercase.length)];
      const randomNumber = numbers[Math.floor(crypto.getRandomValues(new Uint8Array(1))[0] / 256 * numbers.length)];
      const randomSymbol = symbols[Math.floor(crypto.getRandomValues(new Uint8Array(1))[0] / 256 * symbols.length)];
      
      // Fill remaining characters randomly from all categories
      const remainingLength = length - 4;
      let remaining = '';
      for (let i = 0; i < remainingLength; i++) {
        remaining += allChars[Math.floor(crypto.getRandomValues(new Uint8Array(1))[0] / 256 * allChars.length)];
      }
      
      // Combine and shuffle the password
      const password = randomUpper + randomLower + randomNumber + randomSymbol + remaining;
      
      // Shuffle using Fisher-Yates algorithm with crypto.getRandomValues()
      const passwordArray = password.split('');
      for (let i = passwordArray.length - 1; i > 0; i--) {
        const randomIndex = Math.floor(crypto.getRandomValues(new Uint8Array(1))[0] / 256 * (i + 1));
        [passwordArray[i], passwordArray[randomIndex]] = [passwordArray[randomIndex], passwordArray[i]];
      }
      
      return passwordArray.join('');
    }

    async function hashPassword(pw) {
      const buf = new TextEncoder().encode(pw);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
      document.getElementById('successMsg').style.display = 'none';
    }

    function showSuccess(msg) {
      const el = document.getElementById('successMsg');
      el.textContent = msg;
      el.style.display = 'block';
      document.getElementById('errorMsg').style.display = 'none';
    }

    document.getElementById('forgotForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      document.getElementById('errorMsg').style.display = 'none';
      document.getElementById('successMsg').style.display = 'none';
      
      const username = document.getElementById('forgotUsername').value.trim();
      const btn = document.getElementById('forgotBtn');

      if (!username) {
        showError('Please enter your username.');
        return;
      }

      // Check if user exists
      const stored = localStorage.getItem('kryptopesaUser_' + username);
      if (!stored) {
        showError('Username not found. Please check and try again.');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Generating Password...';

      // Generate new secure password using crypto.getRandomValues()
      const newPassword = generateSecurePassword(12);
      console.log('Generated password (for demo):', newPassword); // For testing only

      // Hash the new password
      const newHash = await hashPassword(newPassword);

      // Update user data with new password and set password reset flag
      const userData = JSON.parse(stored);
      userData.passwordHash = newHash;
      userData.passwordResetPending = true; // Force password change on next login
      userData.generatedPassword = newPassword; // Store generated password for reset page
      userData.passwordResetAt = new Date().toISOString();
      localStorage.setItem('kryptopesaUser_' + username, JSON.stringify(userData));

      // Update users database
      const users = JSON.parse(localStorage.getItem('kryptopesa_users_db') || '[]');
      const userIndex = users.findIndex(u => u.username === username);
      if (userIndex !== -1) {
        users[userIndex].lastPasswordReset = new Date().toISOString();
        localStorage.setItem('kryptopesa_users_db', JSON.stringify(users));
      }

      // Log the activity
      const log = JSON.parse(localStorage.getItem('kryptopesa_activity_log') || '[]');
      log.push({ 
        event: 'Password Reset Requested', 
        user: username, 
        status: 'success', 
        timestamp: new Date().toISOString() 
      });
      localStorage.setItem('kryptopesa_activity_log', JSON.stringify(log));

      // Store username in session for reset page
      sessionStorage.setItem('resetPasswordUsername', username);

      showSuccess('New password generated! Redirecting you to create a new password...');
      
      setTimeout(() => {
        window.location.href = 'reset_password.html';
      }, 1500);
    });
  </script>
</body>
</html>
